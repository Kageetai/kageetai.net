---
import { getCollection } from "astro:content";
import { Image, type ImageMetadata } from "astro:assets";
import BaseLayout from "../layouts/BaseLayout.astro";
import { Calendar } from "@lucide/astro";

const content = await getCollection("content");
const formatter = new Intl.DateTimeFormat();

// Import all images from content directory
const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/content/**/attachments/*.{png,jpg,jpeg,webp,gif}",
);

// Helper to resolve image paths
async function resolveImage(imagePath: string | undefined) {
  if (!imagePath) return undefined;

  // Handle relative paths like ./attachments/image.webp
  const normalizedPath = imagePath.startsWith("./")
    ? `/src/content/${imagePath.substring(2)}`
    : imagePath;

  // Try to find matching image
  for (const [path, imageImport] of Object.entries(images)) {
    if (
      path.endsWith(decodeURIComponent(normalizedPath.split("/").pop() || ""))
    ) {
      const image = await imageImport();
      return image.default;
    }
  }

  return undefined;
}

// Resolve images for all content
const contentWithImages = await Promise.all(
  content.map(async (post) => ({
    ...post,
    resolvedImage: await resolveImage(post.data.image),
  })),
);
---

<BaseLayout>
  <h1>Kageetai.net</h1>

  <blockquote>
    Ramblings, musing and the likes. Trying to practice writing and perhaps
    build a digital garden or blog here.
  </blockquote>

  <p>
    My curiosity and passion for frontend development always keeps me trying out
    new technologies and features, the experience with I want to try to share
    here.
  </p>

  <p>
    Check my first articles below. Other projects can also be found on my <a
      href="https://github.com/Kageetai">GitHub profile</a
    >.
  </p>

  <a href="https://skillicons.dev"
    ><img
      src="https://skillicons.dev/icons?i=js,ts,html,css,react,nodejs,npm,bash,git,githubactions,idea,md,figma,obsidian,aws&perline=15"
      alt="My Skills"
    /></a
  >

  <h2>Posts</h2>

  <ul>
    {
      contentWithImages
        .sort((a, b) => b.data.published.getTime() - a.data.published.getTime())
        .map((post) => {
          const published = formatter.format(post.data.published);

          return (
            <li>
              <a href={post.id}>
                <article>
                  {post.resolvedImage && (
                    <Image
                      src={post.resolvedImage}
                      alt={post.data.title}
                      width={400}
                    />
                  )}

                  <header>
                    <h1>{post.data.title}</h1>

                    <div>
                      <small>
                        <Calendar size={14} stroke-width={1} />
                        {published}
                      </small>
                    </div>
                  </header>
                </article>
              </a>
            </li>
          );
        })
    }
  </ul>
</BaseLayout>

<style>
  ul {
    list-style: none;
    padding: 0;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
  }

  article {
    border: 1px solid;
    border-radius: var(--radius);
    overflow: hidden;

    &:hover {
      img {
        transform: scale(1.05);
        transition: transform 0.3s ease-in-out;
      }
    }

    img {
      width: 100%;
      height: auto;
      display: block;
      aspect-ratio: 4 / 3;
      object-fit: cover;
      transition: transform 0.3s ease-in-out;
    }

    h1 {
      min-height: 3.5em;
    }

    header {
      padding: 1rem;
    }
  }
</style>
